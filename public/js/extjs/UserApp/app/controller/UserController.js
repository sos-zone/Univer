/*
 * File: app/controller/UserController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('UserApp.controller.UserController', {
    extend: 'Ext.app.Controller',

    refs: {
        userDataView: 'userPanel userDataView',
        userFormPanel: 'userFormWindow userForm',
        userFormWindow: 'userFormWindow'
    },

    control: {
        "userPanel userDataView": {
            itemclick: 'onDataviewItemClick',
            itemcontextmenu: 'onDataviewItemContextMenu'
        },
        "userPanel button[action='sortByID']": {
            click: 'onSortByIDButtonClick'
        },
        "userPanel button[action='clearFilter']": {
            click: 'onClearFilterButtonClick'
        },
        "userPanel combo[name='user_educ']": {
            change: 'onEducComboboxChange'
        },
        "userPanel combo[name='city_name']": {
            change: 'onCityComboboxChange'
        },
        "userPanel button[action='addUser']": {
            click: 'onAddUserButtonClick'
        },
        "userFormWindow button[action='saveUser']": {
            click: 'onSaveButtonClick'
        }
    },

    onDataviewItemClick: function(dataview, record, item, index, e, eOpts) {
        var win=this.getUserFormWindow();
        if(!win)
            {
                win=Ext.create('UserApp.view.UserFormWindow');
            }
        win.show();
        this.getUserFormPanel().loadRecord(record);
    },

    onSortByIDButtonClick: function(button, e, eOpts) {
        this.getUserDataView().getStore().sort('user_id','DESC');
    },

    onClearFilterButtonClick: function(button, e, eOpts) {
        this.getUserDataView().getStore().clearFilter();
    },

    onEducComboboxChange: function(field, newValue, oldValue, eOpts) {
        this.getUserDataView().getStore().clearFilter();
        this.getUserDataView().getStore().filter('user_educ', newValue);
    },

    onCityComboboxChange: function(field, newValue, oldValue, eOpts) {
        this.getUserDataView().getStore().clearFilter();
        this.getUserDataView().getStore().filter('city_name', newValue);
    },

    onAddUserButtonClick: function(button, e, eOpts) {
        var win = this.getUserFormWindow();
        if(!win)
            {
                win=Ext.create('UserApp.view.UserFormWindow');

            }
        this.getUserFormPanel().loadRecord(Ext.create('UserApp.model.UserModel'));
        this.adding=true;
        win.show();
    },

    onSaveButtonClick: function(button, e, eOpts) {
        var form=this.getUserFormPanel();
        var selectedRecord=form.getRecord();
        if(this.adding)
            {
                this.adding=undefined;
                this.getUserDataView().getStore().add(selectedRecord);

            }
        selectedRecord.set(form.getValues());
        this.getUserDataView().getStore().filter();
        this.getUserFormWindow().close();

        /*
        var ProjStore = this.getUserDataView().getStore();
        var project = ProjStore.findRecord('user_id', user_id);
        return project.get('user_id');
        window.location.href = "http://univer/user?id="+selectedRecord['user_id'];
        */
        var UsStore = Ext.getStore('UserJsonStore');
        UsStore.sync();
    },

    onDataviewItemContextMenu: function(dataview, record, item, index, e, eOpts) {
        e.stopEvent();
        if(!this.ctxMenu)
            {
                this.ctxMenu = Ext.create('Ext.menu.Menu',{
                    items:[{text:'Delete User'}],
                    defaults:{listeners:{click:function(item){
                        this.getUserDataView().getStore().remove([record]);
                        this.getUserDataView().getStore().filter();
                    },
                                         scope: this
                                        }}
                });

            }
        this.ctxMenu.showAt(e.getXY());
    }

});
